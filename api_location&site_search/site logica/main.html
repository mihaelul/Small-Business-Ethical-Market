<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>REO</title>
    <style>
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        margin: 0;
        padding: 0;
        background: #fafafa;
        color: #222;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 80px 24px 24px 24px;
      }
      h1 {
        font-size: 48px;
        margin: 0 0 40px 0;
        color: #2b7cff;
        font-weight: 700;
        text-align: center;
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .product-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
      }
      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .product-name {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: #222;
      }
      .product-company {
        font-size: 14px;
        color: #666;
        margin: 0 0 12px 0;
      }
      .product-price {
        font-size: 20px;
        font-weight: 700;
        color: #2b7cff;
        margin: 0;
      }
      .product-category {
        display: inline-block;
        font-size: 12px;
        padding: 4px 8px;
        background: #f0f0f0;
        border-radius: 4px;
        color: #666;
        margin-top: 12px;
      }
      .no-recommendations {
        text-align: center;
        color: #666;
        padding: 40px;
        font-style: italic;
      }
      .profile-icon {
        position: fixed;
        top: 24px;
        right: 24px;
        width: 48px;
        height: 48px;
        background: #2b7cff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
        box-shadow: 0 2px 8px rgba(43, 124, 255, 0.3);
      }
      .profile-icon:hover {
        transform: scale(1.1);
        background: #1e6ae6;
      }
      .profile-icon svg {
        width: 24px;
        height: 24px;
        fill: white;
      }
      .search-section {
        margin-bottom: 40px;
      }
      .search-bar {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
      }
      .search-input {
        width: 100%;
        padding: 14px 50px 14px 16px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 12px;
        background: white;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        box-sizing: border-box;
      }
      .search-input:focus {
        outline: none;
        border-color: #2b7cff;
        box-shadow: 0 0 0 3px rgba(43, 124, 255, 0.1);
      }
      .search-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        pointer-events: none;
        opacity: 0.5;
      }
      .search-results-section {
        margin-top: 40px;
      }
      .results-count {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <a href="profile.html" class="profile-icon" title="Profile">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
        />
      </svg>
    </a>
    <div class="container">
      <h1>REO</h1>

      <div class="search-section">
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Search products by name, company, or category..."
          />
          <svg
            class="search-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>

      <div class="search-results-section" id="search-results">
        <div class="results-count" id="results-count"></div>
        <div id="search-results-container">
          <div class="no-recommendations">Încărcare produse...</div>
        </div>
      </div>
    </div>

    <script>
      "use strict";
      let allProducts = []; // Produsele din top-products.json

      document.addEventListener("DOMContentLoaded", async () => {
        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");
        const searchResultsContainer = document.getElementById(
          "search-results-container"
        );
        const resultsCount = document.getElementById("results-count");

        // Funcție pentru formatarea prețului
        function formatPrice(priceString) {
          if (!priceString || typeof priceString !== "string") {
            return priceString || "Preț indisponibil";
          }

          // Extrage textul după număr (ex: "Lei", "RON", etc.)
          const parts = priceString.trim().split(/\s+/);
          const currency = parts.slice(1).join(" ") || "";
          const pricePart = parts[0];

          // Dacă deja are virgulă, verific dacă sunt "00" după virgulă
          if (pricePart.includes(",")) {
            const [integerPart, decimalPart] = pricePart.split(",");
            if (decimalPart === "00") {
              return integerPart + (currency ? " " + currency : "");
            }
            return pricePart + (currency ? " " + currency : "");
          }

          // Dacă are punct (separator de mii), verific dacă ultimele 2 cifre sunt zecimale
          if (pricePart.includes(".")) {
            // Elimină punctele (separatori de mii)
            const digitsOnly = pricePart.replace(/\./g, "");

            // Dacă are cel puțin 3 cifre, ultimele 2 ar putea fi zecimale
            if (digitsOnly.length >= 3) {
              const lastTwo = digitsOnly.slice(-2);
              const rest = digitsOnly.slice(0, -2);

              // Dacă ultimele 2 cifre sunt "00", le eliminăm
              if (lastTwo === "00") {
                // Formatează cu puncte ca separator de mii
                const formatted = rest.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return formatted + (currency ? " " + currency : "");
              } else {
                // Formatează cu puncte ca separator de mii și virgulă pentru zecimale
                const formatted = rest.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return (
                  formatted + "," + lastTwo + (currency ? " " + currency : "")
                );
              }
            }
          }

          // Dacă nu are punct sau virgulă, verific dacă are cel puțin 2 cifre
          const digitsOnly = pricePart.replace(/\D/g, "");
          if (digitsOnly.length >= 2) {
            const lastTwo = digitsOnly.slice(-2);
            const rest = digitsOnly.slice(0, -2);

            if (lastTwo === "00") {
              return rest || "0" + (currency ? " " + currency : "");
            } else {
              return (
                (rest || "0") + "," + lastTwo + (currency ? " " + currency : "")
              );
            }
          }

          return priceString;
        }

        // Function to create product card (adaptat pentru structura din top-products.json)
        function createProductCard(product, index) {
          const card = document.createElement("div");
          card.className = "product-card";
          card.style.cursor = "pointer";

          // Salvează produsul în localStorage când se face click
          card.addEventListener("click", () => {
            localStorage.setItem("selectedProduct", JSON.stringify(product));
            window.location.href = "product.html";
          });

          const name = document.createElement("h3");
          name.className = "product-name";
          name.textContent = product.Nume || "Produs fără nume";

          const company = document.createElement("p");
          company.className = "product-company";
          company.textContent = product.Site || "Site necunoscut";

          const price = document.createElement("p");
          price.className = "product-price";
          price.textContent = formatPrice(product.Pret) || "Preț indisponibil";

          card.appendChild(name);
          card.appendChild(company);
          card.appendChild(price);

          return card;
        }

        // Function to display products
        function displayProducts(productsArray, containerElement) {
          containerElement.innerHTML = "";
          if (productsArray.length === 0) {
            containerElement.innerHTML =
              '<div class="no-recommendations">Nu s-au găsit produse.</div>';
            return;
          }

          const grid = document.createElement("div");
          grid.className = "products-grid";

          productsArray.forEach((product, index) => {
            grid.appendChild(createProductCard(product, index));
          });

          containerElement.appendChild(grid);
        }

        // Funcție pentru a încărca produsele din top-products.json
        async function loadProducts() {
          try {
            const response = await fetch("/api/products");
            const data = await response.json();

            if (data.success && data.products) {
              allProducts = data.products;
              displayProducts(allProducts, searchResultsContainer);
              resultsCount.textContent = `${allProducts.length} produse disponibile`;
            } else {
              searchResultsContainer.innerHTML =
                '<div class="no-recommendations">Eroare la încărcarea produselor.</div>';
              resultsCount.textContent = "";
            }
          } catch (error) {
            console.error("Eroare la încărcarea produselor:", error);
            searchResultsContainer.innerHTML =
              '<div class="no-recommendations">Eroare la încărcarea produselor. Verifică dacă serverul rulează.</div>';
            resultsCount.textContent = "";
          }
        }

        // Funcție pentru a căuta produse (trimite keyword către search.js)
        async function searchProducts(keyword) {
          if (!keyword || keyword.trim() === "") {
            // Dacă nu e keyword, reîncarcă produsele inițiale
            await loadProducts();
            return;
          }

          // Afișează mesaj de încărcare
          searchResultsContainer.innerHTML =
            '<div class="no-recommendations">Căutare în curs... Vă rugăm așteptați.</div>';
          resultsCount.textContent = "Căutare în curs...";

          try {
            const response = await fetch("/api/search", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ keyword: keyword.trim() }),
            });

            const data = await response.json();

            if (data.success && data.products) {
              allProducts = data.products;
              displayProducts(allProducts, searchResultsContainer);
              resultsCount.textContent = `Găsite ${allProducts.length} produse pentru "${keyword}"`;
            } else {
              searchResultsContainer.innerHTML =
                '<div class="no-recommendations">Nu s-au găsit produse pentru căutarea ta.</div>';
              resultsCount.textContent = "0 produse găsite";
            }
          } catch (error) {
            console.error("Eroare la căutare:", error);
            searchResultsContainer.innerHTML =
              '<div class="no-recommendations">Eroare la căutare. Verifică dacă serverul rulează.</div>';
            resultsCount.textContent = "Eroare";
          }
        }

        // Event listener pentru Enter în search bar
        searchInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const keyword = searchInput.value.trim();
            if (keyword) {
              searchProducts(keyword);
            }
          }
        });

        // Încarcă produsele inițiale
        await loadProducts();
      });
    </script>
  </body>
</html>
